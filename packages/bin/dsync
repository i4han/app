#!/usr/bin/env coffee
fs = require 'fs'
path = require 'path'
Config = (require 'config').Config

main = process.env.MAIN
packages = process.env.PACKAGES
main_path = packages + '/' + main
lib = process.env.METEOR_LIB
local_config = Config.local_config

if fs.existsSync lib
    ( fs.readdirSync lib ).forEach (file, index) ->
        fs.unlinkSync path.join( lib, file )
else
    fs.mkdirSync lib
    
if fs.existsSync main_path
    ( fs.readdirSync main_path ).forEach (file, index) ->
        if file.search(/^[^_]+\.coffee$/) != -1
            fs.linkSync( path.join( main_path, file ), path.join( lib, file ) )
        else if file == local_config
            modules = (require path.join( packages, main, local_config )).modules
            modules.forEach (module) ->
                module_path = path.join( packages, module )
                if fs.existsSync module_path
                    ( fs.readdirSync module_path ).forEach (file, index) ->
                        if file.search(/^[^_]+\.coffee$/) != -1
                            fs.linkSync( path.join( module_path, file),  path.join( lib, file ) ) 
Config.quit();
