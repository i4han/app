#!/usr/bin/env node
var fs = require("fs");
var es = require("event-stream");
var path = require("path");
try {
    var Config = require("config").Config;
    local_config = Config.local_config
} catch(e) {
    local_config = '_config.coffee';
}

fs.createReadStream(process.argv[2])
    .pipe(es.split("\n"))
    .pipe(es.mapSync(function(data) {
        if (data.search(/^#include\s+["']([^"']+)["']/) != -1) {
            return fs.readFileSync( RegExp.$1 + '.coffee', 'utf8');
        };
        if (data.search(/^#include\s+local\s*.*/) != -1) {
            if ( process.env.PACKAGES && process.env.MAIN ) {
                return fs.readFileSync( path.join( process.env.PACKAGES, process.env.MAIN, local_config), 'utf8');
            } else {
                return '# $PACKAGES and/or $MAIN has not defined.';
            }
        };
        
        return data;
    }))
    .pipe(es.join("\n"))
    .pipe(es.wait())
    .pipe(es.mapSync(function(data) {
        return '#!/usr/bin/env node' + data;
    }))
    .pipe(process.stdout)

if (Config) {
    Config.quit();
}
